<?xml version="1.0"?>
<workflow-app xmlns="uri:oozie:workflow:0.1" name="workflow_2">
    <start to="task1"/>
    <action name="task1">
        <ssh>
            <host>${er_cron_host}</host>
            <command>/bin/bash</command>
            <args>${check_and_mark_max_done_file_script}</args>
            <args>${etl_daily_aggregate_jobs_done_marker_path}</args>
            <args>${rfi_recent_data_ready_marker_path}</args>
            <capture-output/>
        </ssh>
        <ok to="task2"/>
        <error to="fail_1"/>
    </action>

    <action name="task2">
        <ssh>
            <host>${er_cron_host}</host>
            <command>/bin/bash</command>
            <args>${check_and_mark_max_done_file_script}</args>
            <args>${epiphany_daily_attribution_jobs_done_marker_path}</args>
            <args>${rfi_recent_conv_data_ready_marker_path}</args>
            <capture-output/>
        </ssh>
        <ok to="task3"/>
        <error to="fail_1"/>
    </action>

    <fork name="task3">
        <path start="task4"/>
        <path start="task5"/>
        <path start="task6"/>
    </fork>
    <join name="task7" to="task8"/>

    <action name="task4">
        <ssh>
            <host>${er_cron_host}</host>
            <command>${CODE_BASE}/dp/externalreport/whitelist_info_bin</command>
            <args>--type</args>
            <args>conversion</args>
            <args>--output</args>
            <args>${VAR_BASE}/config_conversion_filter.yml</args>
            <capture-output/>
        </ssh>
        <ok to="task7"/>
        <error to="task7"/>
    </action>

    <action name="task5">
        <ssh>
            <host>${er_cron_host}</host>
            <command>/bin/bash</command>
            <args>${CODE_BASE}/scripts/hive/load_rfi_aggregate_impressions</args>
            <args>${environment}</args>
            <args>${er_cron_date_unified}</args>
            <args>${rfi_agg_data_lookback_days}</args>
            <capture-output/>
        </ssh>
        <ok to="task7"/>
        <error to="task7"/>
    </action>

    <action name="task6">
        <ssh>
            <host>${er_cron_host}</host>
            <command>/bin/bash</command>
            <args>${CODE_BASE}/scripts/hive/load_rfi_aggregate_daily_conversion_action</args>
            <args>${environment}</args>
            <args>${er_cron_date_unified}</args>
            <args>${rfi_agg_data_lookback_days}</args>
            <args>${rfi_recent_conv_data_ready_marker_path}</args>
            <args>${er_rfi_agg_daily_conversion_action_marker_path}</args>
            <capture-output/>
        </ssh>
        <ok to="task9"/>
        <error to="task7"/>
    </action>

    <fork name="task9">
        <path start="task10"/>
        <path start="task11"/>
    </fork>

    <action name="task10">
        <ssh>
            <host>${er_cron_host}</host>
            <command>/bin/bash</command>
            <args>${CODE_BASE}/scripts/hive/load_rfi_aggregate_conversion_action</args>
            <args>${environment}</args>
            <args>${er_cron_date_unified}</args>
            <args>${rfi_agg_data_lookback_days}</args>
            <capture-output/>
        </ssh>
        <ok to="task12"/>
        <error to="task12"/>
    </action>

    <action name="task11">
        <ssh>
            <host>${er_cron_host}</host>
            <command>/bin/bash</command>
            <args>${CODE_BASE}/scripts/hive/load_rfi_xd_aggregate_conversion_action</args>
            <args>${environment}</args>
            <args>${er_cron_date_unified}</args>
            <args>${rfi_agg_data_lookback_days}</args>
            <capture-output/>
        </ssh>
        <ok to="task12"/>
        <error to="task12"/>
    </action>

    <join name="task12" to="task7"/>

    <decision name="task8">
        <switch>
            <case to="fail_1">${wf:actionExternalStatus("task4") != "OK"}</case>
            <case to="fail_1">${wf:actionExternalStatus("task5") != "OK"}</case>
            <case to="fail_1">${wf:actionExternalStatus("task10") != "OK"}</case>
            <case to="fail_1">${wf:actionExternalStatus("task6") != "OK"}</case>
            <case to="fail_1">${wf:actionExternalStatus("task11") != "OK"}</case>
            <default to="end_1"/>
        </switch>
    </decision>

    <kill name="fail_1">
        <message>External Report Hourly workflow failed, error
            message[${wf:errorMessage(wf:lastErrorNode())}]
        </message>
    </kill>
    <end name="end_1"/>

</workflow-app>

